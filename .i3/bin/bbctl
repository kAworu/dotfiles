#!/bin/sh
#
# Adjust the backlight brightness level by delta (on a scale of [0, 100]).
#
# the second argument is expected to be a device from /sys/class/backlight. If
# not provided the first device found is used.
#
# Examples:
#
#   % bbctl +10
#   % bbctl -5 amdgpu_bl0

set -e

if [ $# -eq 1 ]; then
    DELTA=$1
    DEVNAME=$(ls -1 /sys/class/backlight | head -n 1)
    if [ "x${DEVNAME}" = x ]; then
        echo "failed to find a backlight device" > /dev/stderr
        exit 1
    fi
elif [ $# -eq 2 ]; then
    DELTA=$1
    DEVNAME=$2
else
    echo "usage $0 delta [device]" > /dev/stderr
    exit 1
fi

case "$DELTA" in
    [+-][0-9]*) ;;
    *)
        echo "$DELTA: invalid delta value" > /dev/stderr
        exit 1
    ;;
esac

if [ ! -d /sys/class/backlight/$DEVNAME ]; then
    echo "failed to find /sys/class/backlight/${DEVNAME}" > /dev/stderr
    exit 1
fi

MIN=0
MAX=$(cat /sys/class/backlight/$DEVNAME/max_brightness)
CURRENT=$(cat /sys/class/backlight/$DEVNAME/brightness)
NEXT=$(echo "$CURRENT + (0 $DELTA * $MAX) / 100" | bc)
[ $NEXT -lt $MIN ] && NEXT=$MIN
[ $NEXT -gt $MAX ] && NEXT=$MAX

if [ -w /sys/class/backlight/$DEVNAME/brightness ]; then
    echo $NEXT > /sys/class/backlight/$DEVNAME/brightness
else
    busctl call \
        org.freedesktop.login1 \
        /org/freedesktop/login1/session/auto \
        org.freedesktop.login1.Session \
        SetBrightness ssu "backlight" $DEVNAME $NEXT
fi
